<div class="servers-section">
    <div class="servers-header">
        <div>
            <h2 class="servers-title">{{ 'pteroca.dashboard.my_servers'|trans }}</h2>
            <p class="servers-subtitle">Manage and monitor your servers</p>
        </div>
        <a href="{{ path('panel', { routeName: 'servers' }) }}" class="btn-view-all">
            {{ 'pteroca.dashboard.view_all_servers'|trans }}
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
        </a>
    </div>
    {% if servers is not empty %}
        <div class="servers-list">
            {% for server in servers %}
                <div class="server-item placeholder-glow placeholder-wave" data-server-id="{{ server.id }}">
                    <div class="server-item-content">
                        <div class="server-icon-wrapper">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" x2="2" y1="12" y2="12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/><line x1="6" x2="6.01" y1="16" y2="16"/><line x1="10" x2="10.01" y1="16" y2="16"/></svg>
                        </div>
                        <div class="server-details">
                            <div class="server-name">{{ server.name ?: server.serverProduct.name }} #{{ server.getPterodactylServerIdentifier }}</div>
                            <div class="server-meta">
                                {% if not server.isSuspended %}
                                    <span class="server-badge server-badge-active">{{ 'pteroca.servers.active'|trans }}</span>
                                    <span class="server-badge placeholder" data-state></span>
                                {% else %}
                                    <span class="server-badge server-badge-suspended">{{ 'pteroca.servers.suspended'|trans }}</span>
                                {% endif %}
                                <span class="server-ip">
                                    <span class="placeholder" data-ip>Loading...</span>
                                </span>
                            </div>
                        </div>
                        <div class="server-actions">
                            {% if not server.isSuspended %}
                                <a href="{% if not use_pterodactyl_panel_as_client_panel() %}{{ path('panel', { routeName: 'server', id: server.pterodactylServerIdentifier }) }}{% else %}{{ get_pterodactyl_panel_url('/server/' ~ server.pterodactylServerIdentifier) }}{% endif %}"
                                   target="{% if use_pterodactyl_panel_as_client_panel() %}_blank{% else %}_self{% endif %}"
                                   class="btn-manage">
                                    {{ 'pteroca.servers.manage_server'|trans }}
                                </a>
                            {% else %}
                                <a href="{{ path('panel', { routeName: 'cart_renew', id: server.id }) }}" 
                                    class="btn-extend">
                                    {{ 'pteroca.servers.extend'|trans }}
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="servers-empty">
            <div class="empty-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" x2="2" y1="12" y2="12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/><line x1="6" x2="6.01" y1="16" y2="16"/><line x1="10" x2="10.01" y1="16" y2="16"/></svg>
            </div>
            <h3 class="empty-title">{{ 'pteroca.dashboard.no_servers'|trans }}</h3>
            <p class="empty-description">{{ 'pteroca.dashboard.no_servers_description'|trans }}</p>
            <a href="{{ path('panel', { routeName: 'store' }) }}" class="btn-order-server">
                {{ 'pteroca.dashboard.order_first_server'|trans }}
            </a>
        </div>
    {% endif %}
</div>

{% block body_javascript %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const servers = document.querySelectorAll('[data-server-id]');

            servers.forEach(server => {
                const serverId = server.getAttribute('data-server-id'),
                    endpointUrl = '{{ path('panel') }}/api/server/' + serverId + '/details'

                fetch(endpointUrl)
                    .then(response => response.json())
                    .then(data => {
                        updateServerDashboardElements(server, data);
                        document.querySelectorAll('.placeholder-glow').forEach(element => element.classList.remove('placeholder-glow'));
                        document.querySelectorAll('.placeholder-wave').forEach(element => element.classList.remove('placeholder-wave'));
                    })
                    .catch(error => console.error('Error fetching server details:', error));
            })

            function updateServerDashboardElements(server, data, prefix = '') {
                for (const [key, value] of Object.entries(data)) {
                    let dataKey = prefix ? `${prefix}-${key}` : key;
                    dataKey = dataKey.replaceAll(' ', '-').replaceAll('.', '-').toLowerCase();
                    if (typeof value === 'object' && value !== null) {
                        updateServerDashboardElements(server, value, dataKey);
                    } else {
                        const element = server.querySelector(`[data-${dataKey}]`);
                        if (element) {
                            if (dataKey === 'state') {
                                updateServerStateBadge(element, value);
                            } else if (element.hasAttribute('data-unit')) {
                                element.textContent = `${value} ${element.getAttribute('data-unit')}`;
                            } else {
                                element.textContent = value;
                            }
                            element.classList.remove('placeholder');
                        }
                    }
                }
            }

            function updateServerStateBadge(element, state) {
                const stateConfig = {
                    'running': { class: 'badge-success', text: '{{ 'pteroca.servers.state.running'|trans }}' },
                    'stopped': { class: 'badge-secondary', text: '{{ 'pteroca.servers.state.stopped'|trans }}' },
                    'starting': { class: 'badge-warning', text: '{{ 'pteroca.servers.state.starting'|trans }}' },
                    'stopping': { class: 'badge-warning', text: '{{ 'pteroca.servers.state.stopping'|trans }}' },
                    'offline': { class: 'badge-danger', text: '{{ 'pteroca.servers.state.offline'|trans }}' }
                };

                const config = stateConfig[state] || { class: 'badge-secondary', text: state };
                
                element.className = `badge ${config.class} me-2`;
                element.textContent = config.text;
            }
        });
    </script>
{% endblock %}
